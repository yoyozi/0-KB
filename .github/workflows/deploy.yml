name: Deploy knowledgebase
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm ci
      - run: npm run build

      - name: Validate secrets
      - run: |
          set -e
          test -n "${{ secrets.SSH_HOST }}" || (echo "Missing SSH_HOST" && exit 1)
          test -n "${{ secrets.SSH_USER }}" || (echo "Missing SSH_USER" && exit 1)
          test -n "${{ secrets.SSH_KEY }}"  || (echo "Missing SSH_KEY"  && exit 1)
      
      - name: Prepare SSH key and known_hosts
      - run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          sed -i 's/\r$//' ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -T 10 -p 22 -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      
      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -T 10 -p 22 -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Rsync build artifacts
        run: |
          set -e
          rsync -avzr --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes" \
            .next/standalone/ \
            .next/static/ \
            public/ \
            package.json \
            package-lock.json \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/knowledgebase.netsecurity.co.za/app/


          - name: Install prod deps and restart service
            run: |
              set -e
              ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} '
                set -e
                cd /var/www/knowledgebase.netsecurity.co.za/app
                echo "PWD=$(pwd)"
                ls -la
                echo "Cleaning any existing node_modules (if present)..."
                rm -rf node_modules
                echo "Installing production dependencies..."
                npm ci --omit=dev --no-audit --no-fund
                echo "Restarting service..."
                sudo /bin/systemctl restart knowledgebase-netsecurity-co-za.service
                echo "Service restarted."
              '
