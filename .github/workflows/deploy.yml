name: Deploy knowledgebase

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Stage deploy artifacts
        run: |
          set -e
          rm -rf deploy
          mkdir -p deploy/.next
          cp -a .next/standalone deploy/.next/
          cp -a .next/static deploy/.next/
          if [ -f .next/BUILD_ID ]; then cp -a .next/BUILD_ID deploy/.next/; fi
          # Include Next.js manifests required to serve chunks/assets
          shopt -s nullglob || true
          for f in .next/*.json; do cp -a "$f" deploy/.next/; done
          # Also mirror required files inside standalone/.next for the Node server
          mkdir -p deploy/.next/standalone/.next
          if [ -f .next/BUILD_ID ]; then cp -a .next/BUILD_ID deploy/.next/standalone/.next/; fi
          for f in .next/*.json; do cp -a "$f" deploy/.next/standalone/.next/; done
          cp -a public deploy/
          cp -a package.json package-lock.json deploy/
          echo "Staged contents:" && find deploy -maxdepth 2 -mindepth 1 -print

      - name: Verify standalone build exists
        run: |
          ls -la .next || true
          if [ ! -f ".next/standalone/server.js" ]; then
            echo "ERROR: .next/standalone/server.js missing."
            echo "Ensure next.config.(js|mjs) sets output: 'standalone'."
            if [ -f next.config.js ]; then echo "--- next.config.js ---"; cat next.config.js; fi
            if [ -f next.config.mjs ]; then echo "--- next.config.mjs ---"; cat next.config.mjs; fi
            exit 1
          fi

      - name: Export BUILD_ID
        run: |
          if [ -f .next/BUILD_ID ]; then
            echo "BUILD_ID=$(cat .next/BUILD_ID)" >> $GITHUB_ENV
            echo "Local BUILD_ID: $(cat .next/BUILD_ID)"
          else
            echo "No .next/BUILD_ID found (older Next); continuing without BUILD_ID check"
          fi

      - name: Validate secrets
        run: |
          test -n "${{ secrets.SSH_HOST }}" || (echo "Missing SSH_HOST secret" && exit 1)
          test -n "${{ secrets.SSH_USER }}" || (echo "Missing SSH_USER secret" && exit 1)
          test -n "${{ secrets.SSH_KEY }}"  || (echo "Missing SSH_KEY secret"  && exit 1)

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -T 10 -p 22 -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Rsync standalone artifacts
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete --exclude='/node_modules' --exclude='.git*'
          path: deploy/
          remote_path: /var/www/knowledgebase.netsecurity.co.za/app/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_KEY }}

      - name: Run database migrations (if configured)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            ENV_FILE=/etc/knowledgebase.netsecurity.co.za.env
            cd /var/www/knowledgebase.netsecurity.co.za/app
            if [ -f "$ENV_FILE" ]; then
              # Read only the MIGRATE_CMD=... line, normalize CRLF, and extract value safely
              MIGRATE_CMD_VALUE=$(sed 's/\r$//' "$ENV_FILE" | grep -E '^MIGRATE_CMD=' | tail -n1 | cut -d= -f2-)
              if [ -n "$MIGRATE_CMD_VALUE" ]; then
                echo "Running migrations: $MIGRATE_CMD_VALUE"
                sh -lc "$MIGRATE_CMD_VALUE"
                echo "Migrations completed."
              else
                echo "No MIGRATE_CMD set in $ENV_FILE; skipping migrations."
              fi
            else
              echo "Env file $ENV_FILE not found; skipping migrations."
            fi

      # No npm ci on server when deploying standalone
      - name: Restart systemd service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            if [ -n "${{ env.BUILD_ID }}" ]; then
              echo "Verifying remote BUILD_ID matches ${{ env.BUILD_ID }}"
              if [ ! -f /var/www/knowledgebase.netsecurity.co.za/app/.next/BUILD_ID ]; then
                echo "ERROR: Remote BUILD_ID file missing"; exit 1;
              fi
              REMOTE_ID=$(cat /var/www/knowledgebase.netsecurity.co.za/app/.next/BUILD_ID)
              echo "Remote BUILD_ID: $REMOTE_ID"
              if [ "$REMOTE_ID" != "${{ env.BUILD_ID }}" ]; then
                echo "ERROR: BUILD_ID mismatch"; exit 1;
              fi
            fi
            sudo -n /bin/systemctl daemon-reload
            sudo -n /bin/systemctl restart knowledgebase-netsecurity-co-za.service
            sudo -n /bin/systemctl status --no-pager knowledgebase-netsecurity-co-za.service || true
            echo "Remote app layout:" && ls -la /var/www/knowledgebase.netsecurity.co.za/app && ls -la /var/www/knowledgebase.netsecurity.co.za/app/.next || true

      - name: Health check (app port)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            for i in {1..10}; do
              if curl -fsS http://127.0.0.1:3003/healthz >/dev/null; then
                echo "App port health OK"; exit 0;
              fi
              echo "Waiting for app port health... ($i)"; sleep 2;
            done
            echo "Health check failed on app port"; exit 1

      - name: Health check (through Nginx)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            for i in {1..10}; do
              if curl -fsS -H "Host: knowledgebase.netsecurity.co.za" http://127.0.0.1/healthz >/dev/null; then
                echo "Nginx health OK"; exit 0;
              fi
              echo "Waiting for Nginx health... ($i)"; sleep 2;
            done
            echo "Health check failed via Nginx"; exit 1
            