name: Deploy knowledgebase

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Stage deploy artifacts
        run: |
          set -e
          rm -rf deploy
          mkdir -p deploy/.next
          cp -a .next/standalone deploy/.next/
          cp -a .next/static deploy/.next/
          cp -a public deploy/
          cp -a package.json package-lock.json deploy/
          echo "Staged contents:" && find deploy -maxdepth 2 -mindepth 1 -print

      - name: Verify standalone build exists
        run: |
          ls -la .next || true
          if [ ! -f ".next/standalone/server.js" ]; then
            echo "ERROR: .next/standalone/server.js missing."
            echo "Ensure next.config.(js|mjs) sets output: 'standalone'."
            if [ -f next.config.js ]; then echo "--- next.config.js ---"; cat next.config.js; fi
            if [ -f next.config.mjs ]; then echo "--- next.config.mjs ---"; cat next.config.mjs; fi
            exit 1
          fi

      - name: Validate secrets
        run: |
          test -n "${{ secrets.SSH_HOST }}" || (echo "Missing SSH_HOST secret" && exit 1)
          test -n "${{ secrets.SSH_USER }}" || (echo "Missing SSH_USER secret" && exit 1)
          test -n "${{ secrets.SSH_KEY }}"  || (echo "Missing SSH_KEY secret"  && exit 1)

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -T 10 -p 22 -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Rsync standalone artifacts
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete --exclude='/node_modules' --exclude='.git*'
          path: deploy/
          remote_path: /var/www/knowledgebase.netsecurity.co.za/app/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_KEY }}

      # No npm ci on server when deploying standalone
      - name: Restart systemd service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            sudo /bin/systemctl daemon-reload
            sudo /bin/systemctl restart knowledgebase-netsecurity-co-za.service
            sudo /bin/systemctl status --no-pager knowledgebase-netsecurity-co-za.service || true
            echo "Remote app layout:" && ls -la /var/www/knowledgebase.netsecurity.co.za/app && ls -la /var/www/knowledgebase.netsecurity.co.za/app/.next || true